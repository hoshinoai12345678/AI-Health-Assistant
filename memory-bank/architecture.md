# AI大健康助手 - 项目架构文档

## 📋 文档信息
- **项目名称**：AI大健康助手
- **版本**：v1.0
- **创建日期**：2026-01-19

---

## 🏗️ 系统架构概览

```
┌─────────────────────────────────────────────────────────────┐
│                        用户层                                │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐   │
│  │  教师端  │  │  学生端  │  │  家长端  │  │ 主管部门 │   │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘   │
│                   微信小程序（原生 + TypeScript）            │
└─────────────────────────────────────────────────────────────┘
                            ↓ HTTPS
┌─────────────────────────────────────────────────────────────┐
│                      API网关层（Nginx）                      │
│              SSL终止 | 负载均衡 | 限流 | 日志                │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│                   后端服务层（FastAPI）                      │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │ AI对话服务   │  │ 资源检索服务 │  │ 用户服务     │     │
│  │ - 关键词识别 │  │ - 内部资源库 │  │ - 认证授权   │     │
│  │ - LLM调用    │  │ - 互联网检索 │  │ - 角色管理   │     │
│  │ - 风险检测   │  │ - 语义搜索   │  │ - 权限控制   │     │
│  └──────────────┘  └──────────────┘  └──────────────┘     │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │ 体测分析服务 │  │ 对话管理服务 │  │ 缓存服务     │     │
│  │ - 成绩分析   │  │ - 历史记录   │  │ - Redis操作  │     │
│  │ - 方案生成   │  │ - 会话管理   │  │ - 热点数据   │     │
│  └──────────────┘  └──────────────┘  └──────────────┘     │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│                      数据存储层                              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │ PostgreSQL   │  │ Redis        │  │ MinIO        │     │
│  │ - 用户数据   │  │ - 会话缓存   │  │ - 视频文件   │     │
│  │ - 体测数据   │  │ - 热点数据   │  │ - 图片文件   │     │
│  │ - 对话记录   │  │ - 限流计数   │  │ - 文档文件   │     │
│  │ - 资源数据   │  └──────────────┘  └──────────────┘     │
│  └──────────────┘                                           │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│                      AI服务层                                │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │ 通义千问API  │  │ 向量数据库   │  │ 语音识别     │     │
│  │ - 对话生成   │  │ - 语义搜索   │  │ - 微信API    │     │
│  │ - 文本理解   │  │ - 相似匹配   │  │ - 阿里云API  │     │
│  └──────────────┘  └──────────────┘  └──────────────┘     │
└─────────────────────────────────────────────────────────────┘
```

---

## 📁 项目目录结构

```
ai-health-assistant/
├── backend/                          # 后端代码
│   ├── app/
│   │   ├── api/                      # API路由
│   │   │   ├── __init__.py
│   │   │   ├── auth.py              # 认证接口
│   │   │   ├── chat.py              # 对话接口
│   │   │   ├── conversation.py      # 对话历史接口
│   │   │   ├── user.py              # 用户接口
│   │   │   └── fitness.py           # 体测接口
│   │   ├── models/                   # 数据模型
│   │   │   ├── __init__.py
│   │   │   ├── user.py              # 用户模型
│   │   │   ├── student.py           # 学生模型
│   │   │   ├── conversation.py      # 对话模型
│   │   │   ├── message.py           # 消息模型
│   │   │   ├── fitness_test.py      # 体测模型
│   │   │   └── resource.py          # 资源模型
│   │   ├── services/                 # 业务逻辑
│   │   │   ├── __init__.py
│   │   │   ├── ai_service.py        # AI服务
│   │   │   ├── keyword_service.py   # 关键词服务
│   │   │   ├── resource_service.py  # 资源服务
│   │   │   ├── fitness_service.py   # 体测服务
│   │   │   ├── cache_service.py     # 缓存服务
│   │   │   └── safety_service.py    # 安全服务
│   │   ├── core/                     # 核心配置
│   │   │   ├── __init__.py
│   │   │   ├── config.py            # 配置管理
│   │   │   ├── database.py          # 数据库连接
│   │   │   ├── redis.py             # Redis连接
│   │   │   └── security.py          # 安全工具
│   │   ├── utils/                    # 工具函数
│   │   │   ├── __init__.py
│   │   │   ├── logger.py            # 日志工具
│   │   │   └── helpers.py           # 辅助函数
│   │   └── main.py                   # 应用入口
│   ├── tests/                        # 测试代码
│   │   ├── test_api.py
│   │   ├── test_services.py
│   │   └── load_test.py
│   ├── alembic/                      # 数据库迁移
│   │   └── versions/
│   ├── scripts/                      # 脚本工具
│   │   └── import_resources.py      # 资源导入
│   ├── requirements.txt              # Python依赖
│   ├── Dockerfile                    # Docker配置
│   └── .env.example                  # 环境变量示例
│
├── miniprogram/                      # 小程序前端
│   ├── pages/                        # 页面
│   │   ├── index/                   # 首页
│   │   │   ├── index.wxml
│   │   │   ├── index.wxss
│   │   │   ├── index.ts
│   │   │   └── index.json
│   │   ├── chat/                    # 对话页
│   │   ├── history/                 # 历史页
│   │   └── profile/                 # 个人页
│   ├── components/                   # 组件
│   │   ├── message-item/            # 消息组件
│   │   └── lazy-image/              # 图片组件
│   ├── utils/                        # 工具
│   │   ├── request.ts               # 网络请求
│   │   └── storage.ts               # 本地存储
│   ├── services/                     # 服务
│   │   ├── auth.ts                  # 认证服务
│   │   └── chat.ts                  # 对话服务
│   ├── images/                       # 图片资源
│   ├── app.json                      # 小程序配置
│   ├── app.ts                        # 小程序入口
│   └── project.config.json           # 项目配置
│
├── docker/                           # Docker配置
│   ├── docker-compose.yml           # 容器编排
│   ├── nginx/
│   │   └── nginx.conf               # Nginx配置
│   └── postgres/
│       └── init.sql                 # 数据库初始化
│
├── memory-bank/                      # 项目文档
│   ├── product-requirements.md      # 产品需求
│   ├── tech-stack.md                # 技术栈
│   ├── implementation-plan-phase1.md # 实施计划1
│   ├── implementation-plan-phase2.md # 实施计划2
│   ├── implementation-plan-phase3.md # 实施计划3
│   ├── architecture.md              # 架构文档（本文件）
│   └── progress.md                  # 进度记录
│
├── docs/                             # 其他文档
│   ├── deployment.md                # 部署文档
│   ├── operations.md                # 运维文档
│   └── api.md                       # API文档
│
├── .gitignore                        # Git忽略
├── README.md                         # 项目说明
└── deploy.sh                         # 部署脚本
```

---

## 🗄️ 数据库设计

### ER图

```
┌─────────────┐         ┌─────────────┐
│   users     │1      n │  students   │
│─────────────│◄────────│─────────────│
│ id (PK)     │         │ id (PK)     │
│ openid      │         │ user_id (FK)│
│ role        │         │ name        │
│ nickname    │         │ grade       │
└─────────────┘         └─────────────┘
       │1                      │1
       │                       │
       │n                      │n
┌─────────────┐         ┌─────────────┐
│conversations│         │fitness_tests│
│─────────────│         │─────────────│
│ id (PK)     │         │ id (PK)     │
│ user_id (FK)│         │ student_id  │
│ title       │         │ test_date   │
└─────────────┘         │ scores...   │
       │1                └─────────────┘
       │
       │n
┌─────────────┐         ┌─────────────┐
│  messages   │         │  resources  │
│─────────────│         │─────────────│
│ id (PK)     │         │ id (PK)     │
│ conv_id (FK)│         │ type        │
│ role        │         │ category    │
│ content     │         │ title       │
│ source      │         │ content     │
└─────────────┘         │ keywords    │
                        └─────────────┘
```

### 表说明

**users（用户表）**
- 存储所有用户的基本信息
- role字段区分用户角色（teacher/student/parent/admin）

**students（学生表）**
- 存储学生的详细信息
- 关联到users表

**fitness_tests（体测表）**
- 存储学生的体测成绩
- 包含各项测试指标

**conversations（对话会话表）**
- 存储对话会话信息
- 一个用户可以有多个会话

**messages（消息表）**
- 存储具体的对话消息
- role: user/assistant/system
- source: internal/internet

**internal_resources（内部资源表）**
- 存储课课练、动作库等内部资源
- keywords字段用于关键词匹配

---

## 🔄 核心业务流程

### 1. 用户登录流程

```
用户打开小程序
    ↓
调用wx.login()获取code
    ↓
调用wx.getUserProfile()获取用户信息
    ↓
发送code和用户信息到后端
    ↓
后端调用微信API换取openid
    ↓
查询或创建用户记录
    ↓
生成JWT token
    ↓
返回token和用户信息
    ↓
小程序保存token
```

### 2. AI对话流程

```
用户输入问题
    ↓
前端发送到后端
    ↓
后端接收并验证token
    ↓
安全检查（风险检测、内容过滤）
    ↓
关键词识别
    ↓
┌─────────────────┐
│ 有内部关键词？   │
└─────────────────┘
    ↓ 是              ↓ 否
检索内部资源库    调用LLM生成回答
    ↓                  ↓
找到资源？        从互联网获取
    ↓ 是              ↓
返回内部资源      标注来源
    ↓                  ↓
    └──────┬──────────┘
           ↓
    添加风险提示（如需要）
           ↓
    保存对话记录
           ↓
    返回给前端
           ↓
    前端显示消息
```

### 3. 体测分析流程

```
用户请求体测分析
    ↓
获取学生最新体测数据
    ↓
计算各项成绩得分
    ↓
识别最弱项和次弱项
    ↓
映射到身体素质
    ↓
从动作库查找训练动作
    ↓
生成训练方案
    ↓
返回给用户
```

---

## 🔐 安全设计

### 认证授权
- **JWT Token**：有效期7天
- **Token刷新**：过期前自动刷新
- **权限控制**：基于角色的访问控制（RBAC）

### 数据安全
- **传输加密**：HTTPS（TLS 1.3）
- **存储加密**：敏感字段AES-256加密
- **密码安全**：bcrypt哈希

### 防护措施
- **限流**：每用户每分钟100次请求
- **SQL注入**：使用ORM参数化查询
- **XSS防护**：输入验证+输出转义
- **CSRF防护**：Token验证

---

## 📊 性能优化

### 缓存策略
- **热点数据**：Redis缓存1小时
- **用户会话**：Redis缓存7天
- **AI响应**：相同问题缓存1小时

### 数据库优化
- **索引**：关键字段建立索引
- **连接池**：20个连接，最大溢出10个
- **查询优化**：避免N+1查询

### 前端优化
- **图片懒加载**：减少初始加载
- **分页加载**：历史记录分页
- **请求合并**：减少网络请求

---

## 📈 监控与日志

### 日志级别
- **DEBUG**：开发调试
- **INFO**：正常信息
- **WARNING**：警告信息
- **ERROR**：错误信息
- **CRITICAL**：严重错误

### 监控指标
- **API响应时间**：目标 < 500ms
- **错误率**：目标 < 1%
- **缓存命中率**：目标 > 60%
- **并发用户数**：实时监控

---

## 🔄 扩展性设计

### 水平扩展
- **无状态服务**：后端服务可水平扩展
- **负载均衡**：Nginx分发请求
- **数据库读写分离**：主从复制

### 功能扩展
- **插件化设计**：新功能独立模块
- **配置化**：关键词配置可动态调整
- **版本控制**：API版本管理

---

**文档状态**：✅ 已完成  
**最后更新**：2026-01-19
