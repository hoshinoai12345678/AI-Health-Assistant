# 生产环境部署指南

## 1. 服务器要求

### 最低配置

- CPU: 2核
- 内存: 4GB
- 硬盘: 50GB SSD
- 带宽: 5Mbps

### 推荐配置

- CPU: 4核
- 内存: 8GB
- 硬盘: 100GB SSD
- 带宽: 10Mbps

---

## 2. 环境准备

### 安装Docker

```bash
# Ubuntu/Debian
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh

# 安装docker-compose
sudo curl -L "https://github.com/docker/compose/releases/download/v2.20.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose
```

### 配置防火墙

```bash
# 开放必要端口
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw allow 22/tcp
sudo ufw enable
```

---

## 3. 部署步骤

### 3.1 克隆代码

```bash
git clone https://github.com/your-org/ai-health-assistant.git
cd ai-health-assistant
```

### 3.2 配置环境变量

创建 `.env.production`:

```bash
# 数据库配置
DATABASE_URL=postgresql+asyncpg://user:password@postgres:5432/aihealth

# Redis配置
REDIS_URL=redis://redis:6379/0

# JWT配置
SECRET_KEY=your-super-secret-key-change-this
ALGORITHM=HS256
ACCESS_TOKEN_EXPIRE_MINUTES=10080

# 微信配置
WECHAT_APP_ID=your_app_id
WECHAT_APP_SECRET=your_app_secret

# AI配置
TONGYI_API_KEY=your_tongyi_api_key
TONGYI_MODEL=qwen-plus

# CORS配置
ALLOWED_ORIGINS=https://your-domain.com
```

### 3.3 启动服务

```bash
# 构建镜像
docker-compose -f docker-compose.prod.yml build

# 启动服务
docker-compose -f docker-compose.prod.yml up -d

# 查看日志
docker-compose -f docker-compose.prod.yml logs -f
```

### 3.4 初始化数据库

```bash
# 运行数据库迁移
docker-compose -f docker-compose.prod.yml exec backend alembic upgrade head

# 导入初始数据
docker-compose -f docker-compose.prod.yml exec backend python scripts/import_resources.py
```

---

## 4. Nginx配置

### 4.1 安装SSL证书

```bash
# 使用Let's Encrypt
sudo apt install certbot python3-certbot-nginx
sudo certbot --nginx -d your-domain.com
```

### 4.2 Nginx配置文件

`/etc/nginx/sites-available/aihealth`:

```nginx
upstream backend {
    server localhost:8000;
}

server {
    listen 80;
    server_name your-domain.com;
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name your-domain.com;

    ssl_certificate /etc/letsencrypt/live/your-domain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/your-domain.com/privkey.pem;

    # 安全配置
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;

    # API代理
    location /api {
        proxy_pass http://backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # 超时配置
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # 限流配置
    limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s;
    limit_req zone=api_limit burst=20 nodelay;
}
```

启用配置:

```bash
sudo ln -s /etc/nginx/sites-available/aihealth /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx
```

---

## 5. 监控配置

### 5.1 日志管理

```bash
# 配置日志轮转
sudo nano /etc/logrotate.d/aihealth

/var/log/aihealth/*.log {
    daily
    rotate 30
    compress
    delaycompress
    notifempty
    create 0640 www-data www-data
    sharedscripts
}
```

### 5.2 健康检查

创建监控脚本 `health_check.sh`:

```bash
#!/bin/bash

HEALTH_URL="https://your-domain.com/health"
RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" $HEALTH_URL)

if [ $RESPONSE -ne 200 ]; then
    echo "Health check failed: $RESPONSE"
    # 发送告警
    curl -X POST "https://api.telegram.org/bot<token>/sendMessage" \
        -d "chat_id=<chat_id>&text=API健康检查失败"
fi
```

添加到crontab:

```bash
*/5 * * * * /path/to/health_check.sh
```

---

## 6. 备份策略

### 6.1 数据库备份

```bash
# 创建备份脚本
#!/bin/bash
BACKUP_DIR="/backup/postgres"
DATE=$(date +%Y%m%d_%H%M%S)

docker-compose -f docker-compose.prod.yml exec -T postgres \
    pg_dump -U user aihealth | gzip > $BACKUP_DIR/backup_$DATE.sql.gz

# 保留最近30天的备份
find $BACKUP_DIR -name "backup_*.sql.gz" -mtime +30 -delete
```

添加到crontab (每天凌晨2点):

```bash
0 2 * * * /path/to/backup.sh
```

### 6.2 Redis备份

Redis会自动持久化到 `dump.rdb`，定期备份该文件即可。

---

## 7. 性能优化

### 7.1 数据库优化

```sql
-- 创建索引
CREATE INDEX idx_users_openid ON users(openid);
CREATE INDEX idx_conversations_user_id ON conversations(user_id);
CREATE INDEX idx_messages_conversation_id ON messages(conversation_id);
CREATE INDEX idx_resources_keywords ON internal_resources USING GIN(keywords);

-- 分析表
ANALYZE users;
ANALYZE conversations;
ANALYZE messages;
ANALYZE internal_resources;
```

### 7.2 Redis优化

```bash
# redis.conf
maxmemory 2gb
maxmemory-policy allkeys-lru
save 900 1
save 300 10
save 60 10000
```

---

## 8. 安全加固

### 8.1 系统安全

```bash
# 禁用root登录
sudo nano /etc/ssh/sshd_config
# PermitRootLogin no

# 配置fail2ban
sudo apt install fail2ban
sudo systemctl enable fail2ban
```

### 8.2 应用安全

- 更改所有默认密钥
- 启用HTTPS
- 配置CORS白名单
- 启用API限流
- 定期更新依赖

---

## 9. 故障排查

### 常见问题

**问题1: 容器无法启动**

```bash
# 查看日志
docker-compose logs backend

# 检查配置
docker-compose config
```

**问题2: 数据库连接失败**

```bash
# 检查数据库状态
docker-compose exec postgres pg_isready

# 测试连接
docker-compose exec backend python -c "from app.core.database import engine; print('OK')"
```

**问题3: Redis连接失败**

```bash
# 检查Redis状态
docker-compose exec redis redis-cli ping
```

---

## 10. 部署检查清单

- [ ] 服务器配置满足要求
- [ ] Docker和docker-compose已安装
- [ ] 环境变量已正确配置
- [ ] SSL证书已安装
- [ ] 数据库已初始化
- [ ] 初始数据已导入
- [ ] Nginx配置已生效
- [ ] 防火墙规则已配置
- [ ] 日志轮转已配置
- [ ] 备份脚本已设置
- [ ] 监控告警已配置
- [ ] 健康检查正常
- [ ] API测试通过
- [ ] 性能测试达标
