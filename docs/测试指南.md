# 测试指南

## 1. 环境准备

### 安装测试依赖

```bash
cd backend
pip install -r requirements-dev.txt
```

---

## 2. 单元测试

### 运行所有测试

```bash
pytest tests/ -v
```

### 运行特定测试文件

```bash
# 测试关键词服务
pytest tests/test_keyword_service.py -v

# 测试体测服务
pytest tests/test_fitness_service.py -v

# 测试安全服务
pytest tests/test_safety_service.py -v
```

### 查看测试覆盖率

```bash
pytest tests/ --cov=app --cov-report=html
```

覆盖率报告会生成在 `htmlcov/index.html`

---

## 3. 集成测试

### 运行集成测试

```bash
pytest tests/test_integration.py -v
```

### 测试场景

- 用户登录认证
- 发送对话消息
- 获取对话历史
- 体测数据分析
- 安全内容检查

---

## 4. 性能测试

### 使用Locust进行压力测试

创建 `locustfile.py`:

```python
from locust import HttpUser, task, between

class APIUser(HttpUser):
    wait_time = between(1, 3)
    
    def on_start(self):
        # 登录获取token
        response = self.client.post("/api/auth/login", json={
            "wechat_code": "test_code"
        })
        self.token = response.json()["access_token"]
    
    @task(3)
    def send_message(self):
        self.client.post(
            "/api/chat/send",
            json={"message": "如何提高跑步速度？"},
            headers={"Authorization": f"Bearer {self.token}"}
        )
    
    @task(1)
    def get_conversations(self):
        self.client.get(
            "/api/conversation/list",
            headers={"Authorization": f"Bearer {self.token}"}
        )
```

运行测试:

```bash
locust -f locustfile.py --host=http://localhost:8000
```

访问 http://localhost:8089 查看测试结果

---

## 5. API测试

### 使用httpie测试

```bash
# 登录
http POST localhost:8000/api/auth/login wechat_code=test

# 发送消息
http POST localhost:8000/api/chat/send \
  message="如何提高跑步速度？" \
  Authorization:"Bearer YOUR_TOKEN"

# 获取对话列表
http GET localhost:8000/api/conversation/list \
  Authorization:"Bearer YOUR_TOKEN"
```

---

## 6. 测试数据

### 创建测试数据

```bash
cd backend
python scripts/import_resources.py
```

### 测试用户

```python
# 测试账号
{
  "openid": "test_student_001",
  "role": "student",
  "name": "测试学生"
}
```

---

## 7. 持续集成

### GitHub Actions配置

创建 `.github/workflows/test.yml`:

```yaml
name: Tests

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v2
    
    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: 3.11
    
    - name: Install dependencies
      run: |
        pip install -r requirements.txt
        pip install -r requirements-dev.txt
    
    - name: Run tests
      run: pytest tests/ --cov=app
```

---

## 8. 测试最佳实践

### 测试命名

```python
# ✅ 好的命名
def test_send_message_success():
    pass

def test_send_unsafe_message_should_fail():
    pass

# ❌ 不好的命名
def test1():
    pass
```

### 测试隔离

每个测试应该独立，不依赖其他测试：

```python
@pytest.fixture
def clean_db():
    # 每次测试前清理数据库
    db.clear()
    yield
    db.clear()
```

### 使用Mock

```python
from unittest.mock import Mock, patch

@patch('app.services.ai_service.call_ai_api')
def test_with_mock(mock_ai):
    mock_ai.return_value = "模拟响应"
    result = process_message("测试")
    assert result == "模拟响应"
```

---

## 9. 测试检查清单

- [ ] 所有单元测试通过
- [ ] 测试覆盖率 > 80%
- [ ] 集成测试通过
- [ ] 性能测试达标
- [ ] 边界条件测试
- [ ] 错误处理测试
- [ ] 安全测试通过
