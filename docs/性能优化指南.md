# 性能优化指南

## 1. 缓存策略

### Redis缓存配置

项目使用Redis作为缓存层，提升响应速度：

```python
# 缓存过期时间
- 用户信息: 1小时
- 资源数据: 1小时
- 关键词检测: 1小时
- 对话列表: 5分钟
```

### 缓存命中率监控

```python
from app.core.performance import performance_metrics

# 获取缓存命中率
hit_rate = performance_metrics.get_cache_hit_rate()
print(f"缓存命中率: {hit_rate:.2%}")
```

---

## 2. 数据库优化

### 连接池配置

```python
# app/core/database.py
pool_size=20              # 连接池大小
max_overflow=10           # 最大溢出连接
pool_timeout=30           # 连接超时
pool_recycle=3600         # 连接回收时间
pool_pre_ping=True        # 连接前检查
```

### 索引优化

确保以下字段已建立索引：
- `users.openid`
- `conversations.user_id`
- `messages.conversation_id`
- `internal_resources.keywords` (GIN索引)

---

## 3. API性能监控

### 性能计时装饰器

```python
from app.core.performance import timing_decorator

@timing_decorator
async def my_function():
    # 自动记录执行时间
    pass
```

### 慢查询日志

超过1秒的操作会自动记录警告日志：

```
WARNING: 慢操作: search_internal 耗时 1.23秒
```

---

## 4. 前端优化

### 请求防抖

```typescript
// 防止重复提交
let isSubmitting = false;

async function sendMessage() {
  if (isSubmitting) return;
  isSubmitting = true;
  
  try {
    await api.post('/chat/send', data);
  } finally {
    isSubmitting = false;
  }
}
```

### 列表分页加载

```typescript
// 对话列表分页
const pageSize = 20;
let currentPage = 0;

async function loadMore() {
  const data = await api.get('/conversation/list', {
    skip: currentPage * pageSize,
    limit: pageSize
  });
  currentPage++;
}
```

---

## 5. 性能测试

### 使用Locust进行压力测试

```python
# locustfile.py
from locust import HttpUser, task, between

class APIUser(HttpUser):
    wait_time = between(1, 3)
    
    @task
    def send_message(self):
        self.client.post("/api/chat/send", json={
            "message": "测试消息",
            "conversation_id": None
        })
```

运行测试：
```bash
locust -f locustfile.py --host=http://localhost:8000
```

---

## 6. 性能指标

### 目标指标

- API响应时间: < 500ms (P95)
- 数据库查询: < 100ms (P95)
- 缓存命中率: > 80%
- 并发用户: > 1000

### 监控命令

```bash
# 查看Redis状态
redis-cli info stats

# 查看数据库连接
psql -c "SELECT count(*) FROM pg_stat_activity;"
```

---

## 7. 优化建议

1. **启用CDN**: 静态资源使用CDN加速
2. **图片优化**: 使用WebP格式，压缩图片
3. **代码分割**: 小程序分包加载
4. **懒加载**: 非首屏内容延迟加载
5. **预加载**: 预测用户行为，提前加载数据
