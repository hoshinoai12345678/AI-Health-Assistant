# 安全加固指南

## 1. 认证与授权

### JWT Token安全

```python
# 配置
SECRET_KEY: 使用强随机密钥
ALGORITHM: HS256
ACCESS_TOKEN_EXPIRE: 7天

# 最佳实践
- Token存储在小程序storage中
- 每次请求携带在Authorization头
- Token过期后自动刷新
```

### 权限控制

```python
# 基于角色的访问控制
roles = ["student", "teacher", "parent", "admin"]

# 权限装饰器
@require_role("teacher")
async def teacher_only_api():
    pass
```

---

## 2. 输入验证

### 自动验证

所有API输入都经过验证：

```python
from app.utils.validation import input_validator

# 消息验证
message = input_validator.validate_message(message)

# 手机号验证
phone = input_validator.validate_phone(phone)

# HTML清理
text = input_validator.sanitize_html(text)
```

### 验证规则

- 消息长度: 1-2000字符
- 年级范围: 1-12
- 性别: male/female
- 手机号: 11位数字
- 邮箱: 标准格式

---

## 3. 内容安全

### 敏感词过滤

```python
from app.services.safety_service import safety_service

# 检查内容安全
result = safety_service.check_content(text)

if not result['is_safe']:
    # 拒绝请求
    raise HTTPException(400, "内容包含敏感信息")
```

### 风险等级

- **safe**: 安全内容
- **low**: 低风险（警告）
- **medium**: 中风险（过滤）
- **high**: 高风险（拒绝）

---

## 4. API限流

### 限流策略

```python
# 全局限流
max_requests = 100  # 每分钟最多100次请求
window = 60         # 时间窗口60秒

# 触发限流返回429错误
```

### IP黑名单

```python
# 可配置IP黑名单
BLOCKED_IPS = [
    "192.168.1.100",
    "10.0.0.50"
]
```

---

## 5. 数据加密

### 传输加密

- 所有API必须使用HTTPS
- TLS 1.2+
- 强加密套件

### 敏感数据加密

```python
# 密码加密
from passlib.context import CryptContext

pwd_context = CryptContext(schemes=["bcrypt"])
hashed = pwd_context.hash(password)
```

---

## 6. SQL注入防护

### 使用ORM

```python
# ✅ 安全：使用SQLAlchemy ORM
query = select(User).where(User.id == user_id)

# ❌ 危险：拼接SQL
query = f"SELECT * FROM users WHERE id = {user_id}"
```

### 参数化查询

所有数据库查询都使用参数化，防止SQL注入。

---

## 7. XSS防护

### 响应头

```python
# 自动添加安全响应头
X-Content-Type-Options: nosniff
X-Frame-Options: DENY
X-XSS-Protection: 1; mode=block
```

### 内容转义

```python
# HTML内容自动转义
from html import escape

safe_content = escape(user_input)
```

---

## 8. CSRF防护

### 微信小程序

小程序使用JWT Token，天然防CSRF攻击。

### 额外措施

- 验证Referer头
- 使用随机Token
- 双重提交Cookie

---

## 9. 日志与监控

### 安全日志

```python
# 记录安全事件
logger.warning(f"限流触发: {client_ip}")
logger.error(f"敏感内容检测: {risk_keywords}")
logger.info(f"登录成功: user_id={user_id}")
```

### 异常监控

```python
# 捕获并记录所有异常
try:
    result = await process()
except Exception as e:
    logger.error(f"处理失败: {e}", exc_info=True)
    raise
```

---

## 10. 安全检查清单

### 部署前检查

- [ ] 更改默认密钥
- [ ] 启用HTTPS
- [ ] 配置防火墙
- [ ] 限制数据库访问
- [ ] 启用日志记录
- [ ] 配置备份策略
- [ ] 测试限流机制
- [ ] 验证权限控制
- [ ] 检查敏感信息泄露
- [ ] 更新依赖包

### 定期审计

- 每月检查日志
- 每季度更新依赖
- 每年安全审计
- 及时修复漏洞

---

## 11. 应急响应

### 发现安全问题

1. 立即隔离受影响系统
2. 分析攻击向量
3. 修复漏洞
4. 通知用户
5. 更新安全策略

### 联系方式

安全问题请联系：security@example.com
