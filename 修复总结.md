# API 404 é”™è¯¯ä¿®å¤æ€»ç»“

## ğŸ“Œ é—®é¢˜æè¿°

æ ¹æ®æœåŠ¡å™¨æ—¥å¿—ï¼Œ`POST /api/chat/send` è¿”å› 404 é”™è¯¯ï¼š

```
2026-01-20 14:46:12,280 - POST /api/chat/send çŠ¶æ€ç =404
```

**æ ¹æœ¬åŸå› ï¼š** å‰ç«¯é€šè¿‡ `Authorization: Bearer <token>` Header å‘é€è®¤è¯ä¿¡æ¯ï¼Œä½†åç«¯æœŸæœ› token ä½œä¸ºæŸ¥è¯¢å‚æ•°ã€‚

## âœ… å·²å®Œæˆçš„ä¿®å¤

### åç«¯ä»£ç ä¿®æ”¹ï¼ˆbackend/ï¼‰

#### 1. `backend/app/core/security.py`
- âœ… æ·»åŠ  `get_current_user()` å‡½æ•°
- âœ… æ”¯æŒä» `Authorization: Bearer <token>` Header æå– token
- âœ… æ ‡å‡†çš„ FastAPI ä¾èµ–æ³¨å…¥æ–¹å¼

#### 2. `backend/app/api/chat.py`
- âœ… `/send` ç«¯ç‚¹æ”¹ç”¨ `Depends(get_current_user)`
- âœ… å“åº”å­—æ®µä» `message` æ”¹ä¸º `reply`ï¼ˆåŒ¹é…å‰ç«¯ï¼‰
- âœ… ç§»é™¤æŸ¥è¯¢å‚æ•° `token: str`

#### 3. `backend/app/api/conversation.py`
- âœ… æ‰€æœ‰ç«¯ç‚¹æ”¹ç”¨ `Depends(get_current_user)`
- âœ… `/list` ç«¯ç‚¹å“åº”æ ¼å¼ä¼˜åŒ–
- âœ… `/{conversation_id}` ç«¯ç‚¹è¿”å›å®Œæ•´å¯¹è¯ä¿¡æ¯

#### 4. `backend/app/api/auth.py`
- âœ… æ·»åŠ  `/login` ç«¯ç‚¹ï¼ˆç”¨äº Web ç‰ˆæµ‹è¯•ï¼‰
- âœ… å“åº”å­—æ®µä¸º `access_token`ï¼ˆæ ‡å‡†å‘½åï¼‰
- âœ… æ”¯æŒç®€å•çš„ç”¨æˆ·åå¯†ç ç™»å½•

#### 5. `backend/app/api/fitness.py`
- âœ… æ”¹ç”¨ `Depends(get_current_user)`

### WebæœåŠ¡å™¨æ–‡æ¡£ï¼ˆweb-server/ï¼‰

#### 1. `web-server/start.sh`
- âœ… å®Œæ•´çš„ä¸€é”®éƒ¨ç½²è„šæœ¬
- âœ… è‡ªåŠ¨æ£€æŸ¥åç«¯ä»£ç æ›´æ–°
- âœ… ç³»ç»Ÿä¾èµ–å®‰è£…
- âœ… æ•°æ®åº“åˆå§‹åŒ–
- âœ… è¯¦ç»†çš„çŠ¶æ€æ˜¾ç¤º

#### 2. `web-server/éƒ¨ç½²æ›´æ–°è¯´æ˜.md`
- âœ… è¯¦ç»†çš„éƒ¨ç½²æ­¥éª¤
- âœ… å¸¸è§é—®é¢˜è§£ç­”
- âœ… å›æ»šæ–¹æ¡ˆ

#### 3. `web-server/éƒ¨ç½²æ£€æŸ¥æ¸…å•.md`
- âœ… éƒ¨ç½²å‰æ£€æŸ¥é¡¹
- âœ… éƒ¨ç½²æ­¥éª¤
- âœ… éªŒè¯æ–¹æ³•
- âœ… æ•…éšœæ’æŸ¥æŒ‡å—

## ğŸ“¦ éœ€è¦ä¸Šä¼ åˆ°æœåŠ¡å™¨çš„æ–‡ä»¶

```
backend/app/core/security.py
backend/app/api/chat.py
backend/app/api/conversation.py
backend/app/api/auth.py
backend/app/api/fitness.py
web-server/start.sh
web-server/éƒ¨ç½²æ›´æ–°è¯´æ˜.md
web-server/éƒ¨ç½²æ£€æŸ¥æ¸…å•.md
```

## ğŸš€ æœåŠ¡å™¨éƒ¨ç½²æ­¥éª¤ï¼ˆç®€åŒ–ç‰ˆï¼‰

### 1. ä¸Šä¼ æ–‡ä»¶
å°†ä¸Šè¿°æ–‡ä»¶ä¸Šä¼ åˆ°æœåŠ¡å™¨å¯¹åº”ä½ç½®

### 2. è®¾ç½®æƒé™
```bash
cd /path/to/ctz_project/web-server
chmod +x start.sh
```

### 3. åœæ­¢å½“å‰æœåŠ¡
```bash
# æ‰¾åˆ°è¿›ç¨‹ID
ps aux | grep "python.*main.py"

# åœæ­¢è¿›ç¨‹
kill <PID>
```

### 4. å¯åŠ¨æœåŠ¡
```bash
cd /path/to/ctz_project/web-server
./start.sh
```

### 5. éªŒè¯
```bash
# å¥åº·æ£€æŸ¥
curl http://localhost:9000/health

# æµ‹è¯•ç™»å½•
curl -X POST http://localhost:9000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"test","password":"test"}'

# æµ‹è¯•èŠå¤©ï¼ˆä½¿ç”¨ä¸Šä¸€æ­¥çš„ tokenï¼‰
curl -X POST http://localhost:9000/api/chat/send \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer <token>" \
  -d '{"message":"ä½ å¥½"}'
```

## ğŸ” å…³é”®ä»£ç å˜æ›´

### ä¿®æ”¹å‰ï¼ˆé”™è¯¯çš„æ–¹å¼ï¼‰

```python
@router.post("/send")
async def send_message(
    request: ChatRequest,
    token: str,  # âŒ ä½œä¸ºæŸ¥è¯¢å‚æ•°
    db: AsyncSession = Depends(get_db)
):
    payload = verify_token(token)
    if not payload:
        raise HTTPException(...)
```

### ä¿®æ”¹åï¼ˆæ­£ç¡®çš„æ–¹å¼ï¼‰

```python
@router.post("/send")
async def send_message(
    request: ChatRequest,
    current_user: dict = Depends(get_current_user),  # âœ… ä¾èµ–æ³¨å…¥
    db: AsyncSession = Depends(get_db)
):
    user_id = current_user.get("user_id")
```

### æ–°å¢çš„è®¤è¯å‡½æ•°

```python
def get_current_user(authorization: Optional[str] = Header(None)) -> Dict[str, Any]:
    """ä» Authorization Header ä¸­è·å–å½“å‰ç”¨æˆ·"""
    if not authorization:
        raise HTTPException(status_code=401, detail="æœªæä¾›è®¤è¯ä¿¡æ¯")
    
    parts = authorization.split()
    if len(parts) != 2 or parts[0].lower() != "bearer":
        raise HTTPException(status_code=401, detail="æ— æ•ˆçš„è®¤è¯æ ¼å¼")
    
    token = parts[1]
    payload = verify_token(token)
    
    if not payload:
        raise HTTPException(status_code=401, detail="æ— æ•ˆçš„token")
    
    return payload
```

## ğŸ“Š API ç«¯ç‚¹å˜æ›´å¯¹æ¯”

| ç«¯ç‚¹ | ä¿®æ”¹å‰ | ä¿®æ”¹å | çŠ¶æ€ |
|------|--------|--------|------|
| POST /api/chat/send | token æŸ¥è¯¢å‚æ•° | Bearer Token Header | âœ… å·²ä¿®å¤ |
| GET /api/conversation/list | token æŸ¥è¯¢å‚æ•° | Bearer Token Header | âœ… å·²ä¿®å¤ |
| GET /api/conversation/{id} | token æŸ¥è¯¢å‚æ•° | Bearer Token Header | âœ… å·²ä¿®å¤ |
| DELETE /api/conversation/{id} | token æŸ¥è¯¢å‚æ•° | Bearer Token Header | âœ… å·²ä¿®å¤ |
| GET /api/fitness/analyze/{id} | token æŸ¥è¯¢å‚æ•° | Bearer Token Header | âœ… å·²ä¿®å¤ |
| POST /api/auth/login | - | æ–°å¢ | âœ… æ–°åŠŸèƒ½ |

## ğŸ¯ é¢„æœŸæ•ˆæœ

ä¿®å¤åï¼Œå‰ç«¯çš„è¯·æ±‚å°†æ­£å¸¸å·¥ä½œï¼š

```javascript
// å‰ç«¯ä»£ç ï¼ˆæ— éœ€ä¿®æ”¹ï¼‰
const response = await fetch(`${API_BASE_URL}/api/chat/send`, {
    method: 'POST',
    headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`  // âœ… ç°åœ¨å¯ä»¥æ­£ç¡®è¯†åˆ«
    },
    body: JSON.stringify({
        message: text,
        conversation_id: currentConversationId
    })
});

const data = await response.json();
// data.reply åŒ…å« AI å›å¤
// data.conversation_id åŒ…å«å¯¹è¯ID
```

## âœ¨ æµ‹è¯•åœºæ™¯

### åœºæ™¯ 1: æ–°ç”¨æˆ·ç™»å½•å¹¶èŠå¤©
1. è®¿é—® http://æœåŠ¡å™¨IP:9000
2. ç‚¹å‡»"ä¸ªäººä¸­å¿ƒ" â†’ "ç™»å½•"
3. è¾“å…¥ä»»æ„ç”¨æˆ·åå’Œå¯†ç ï¼ˆè‡ªåŠ¨åˆ›å»ºè´¦å·ï¼‰
4. è¿”å›"èŠå¤©"æ ‡ç­¾
5. å‘é€æ¶ˆæ¯ï¼š"ä½ å¥½"
6. âœ… åº”è¯¥æ”¶åˆ° AI å›å¤ï¼Œä¸å†å‡ºç° 404

### åœºæ™¯ 2: æŸ¥çœ‹å†å²è®°å½•
1. å‘é€å¤šæ¡æ¶ˆæ¯
2. ç‚¹å‡»"å†å²"æ ‡ç­¾
3. âœ… åº”è¯¥çœ‹åˆ°å¯¹è¯åˆ—è¡¨
4. ç‚¹å‡»æŸä¸ªå¯¹è¯
5. âœ… åº”è¯¥åŠ è½½å†å²æ¶ˆæ¯

### åœºæ™¯ 3: API ç›´æ¥è°ƒç”¨
```bash
# 1. ç™»å½•è·å– token
TOKEN=$(curl -s -X POST http://localhost:9000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"test","password":"test"}' | jq -r '.access_token')

# 2. å‘é€æ¶ˆæ¯
curl -X POST http://localhost:9000/api/chat/send \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $TOKEN" \
  -d '{"message":"ä½ å¥½"}' | jq

# âœ… åº”è¯¥è¿”å› 200 çŠ¶æ€ç å’Œ AI å›å¤
```

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **å¿…é¡»é‡å¯æœåŠ¡**ï¼šä»£ç æ›´æ–°åå¿…é¡»é‡å¯ web-server
2. **æ¸…é™¤æµè§ˆå™¨ç¼“å­˜**ï¼šå»ºè®®æ¸…é™¤ç¼“å­˜æˆ–ä½¿ç”¨æ— ç—•æ¨¡å¼æµ‹è¯•
3. **æ£€æŸ¥æ—¥å¿—**ï¼šéƒ¨ç½²åæŸ¥çœ‹æ—¥å¿—ç¡®è®¤æ²¡æœ‰é”™è¯¯
4. **å¤‡ä»½ä»£ç **ï¼šéƒ¨ç½²å‰å»ºè®®å¤‡ä»½å½“å‰ä»£ç 

## ğŸ“š ç›¸å…³æ–‡æ¡£

- `web-server/éƒ¨ç½²æ›´æ–°è¯´æ˜.md` - è¯¦ç»†éƒ¨ç½²æŒ‡å—
- `web-server/éƒ¨ç½²æ£€æŸ¥æ¸…å•.md` - éƒ¨ç½²æ£€æŸ¥æ¸…å•
- `web-server/start.sh` - ä¸€é”®éƒ¨ç½²è„šæœ¬

## ğŸ‰ å®Œæˆæ ‡å¿—

éƒ¨ç½²æˆåŠŸåï¼Œæ‚¨åº”è¯¥çœ‹åˆ°ï¼š

- âœ… æµè§ˆå™¨å¯ä»¥æ­£å¸¸è®¿é—® Web ç•Œé¢
- âœ… ç™»å½•åŠŸèƒ½æ­£å¸¸
- âœ… å‘é€æ¶ˆæ¯è¿”å› 200 çŠ¶æ€ç ï¼ˆä¸å†æ˜¯ 404ï¼‰
- âœ… æ”¶åˆ° AI å›å¤
- âœ… å†å²è®°å½•åŠŸèƒ½æ­£å¸¸
- âœ… æœåŠ¡å™¨æ—¥å¿—ä¸­æ²¡æœ‰ 404 é”™è¯¯

---

**ç‰ˆæœ¬ï¼š** 1.1.0  
**æ›´æ–°æ—¥æœŸï¼š** 2026-01-20  
**ä¿®å¤å†…å®¹ï¼š** API è®¤è¯æ–¹å¼ä¼˜åŒ–ï¼Œæ”¯æŒæ ‡å‡† Bearer Token
