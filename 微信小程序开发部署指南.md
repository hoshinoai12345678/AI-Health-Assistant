# 微信小程序完整开发部署指南

---

## 📋 目录

1. [微信小程序注册](#1-微信小程序注册)
2. [开发工具安装](#2-开发工具安装)
3. [小程序配置](#3-小程序配置)
4. [本地开发](#4-本地开发)
5. [小程序上传发布](#5-小程序上传发布)
6. [常见问题](#6-常见问题)

---

## 1. 微信小程序注册

### 1.1 注册小程序账号

1. **访问微信公众平台**
   - 网址：https://mp.weixin.qq.com/
   - 点击右上角 "立即注册"

2. **选择账号类型**
   - 选择 "小程序"
   - 点击 "查看类型区别" 了解详情

3. **填写账号信息**
   - 邮箱：填写未注册过微信公众平台的邮箱
   - 密码：设置登录密码
   - 验证码：填写图片验证码
   - 勾选同意协议
   - 点击 "注册"

4. **邮箱激活**
   - 登录邮箱
   - 点击激活链接
   - 完成激活

5. **信息登记**
   - **主体类型**：选择 "个人" 或 "企业"
   - **主体信息**：
     - 个人：身份证信息、手机号
     - 企业：营业执照、法人信息
   - **管理员信息**：
     - 姓名、身份证号
     - 手机号（需要微信扫码验证）

6. **完成注册**
   - 提交审核
   - 等待审核通过（通常1-3个工作日）

### 1.2 获取小程序配置信息

注册成功后，登录小程序后台：

1. **获取AppID**
   - 登录 https://mp.weixin.qq.com/
   - 左侧菜单：开发 → 开发管理 → 开发设置
   - 复制 **AppID (小程序ID)**
   - 示例：`wx1234567890abcdef`

2. **获取AppSecret**
   - 在同一页面找到 **AppSecret(小程序密钥)**
   - 点击 "生成" 或 "重置"
   - **立即复制并保存**（只显示一次）
   - 示例：`a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6`

3. **配置服务器域名**
   - 开发 → 开发管理 → 开发设置
   - 找到 "服务器域名"
   - 点击 "修改"
   - 添加你的后端API域名：
     - request合法域名：`https://your-api-domain.com`
     - uploadFile合法域名：`https://your-api-domain.com`
     - downloadFile合法域名：`https://your-api-domain.com`
   - **注意**：必须是HTTPS域名，不能是IP地址

---

## 2. 开发工具安装

### 2.1 下载微信开发者工具

1. **访问下载页面**
   - 网址：https://developers.weixin.qq.com/miniprogram/dev/devtools/download.html

2. **选择版本下载**
   - Windows 64位：稳定版
   - macOS：稳定版
   - Linux：稳定版

3. **安装开发者工具**
   - Windows：双击 `.exe` 文件安装
   - macOS：拖动到应用程序文件夹
   - Linux：解压后运行

4. **启动并登录**
   - 打开微信开发者工具
   - 使用微信扫码登录
   - 确保登录的微信号是小程序管理员或开发者

---

## 3. 小程序配置

### 3.1 配置项目文件

#### 修改 `miniprogram/project.config.json`

```json
{
  "appid": "你的AppID",
  "projectname": "AI健康助手",
  "description": "三精准小程序",
  "setting": {
    "urlCheck": true,
    "es6": true,
    "enhance": true,
    "postcss": true,
    "minified": true
  },
  "compileType": "miniprogram"
}
```

**替换内容**：
- 将 `"appid"` 的值改为你的小程序AppID

#### 修改 `miniprogram/app.json`

```json
{
  "pages": [
    "pages/home/home",
    "pages/chat/chat",
    "pages/history/history",
    "pages/profile/profile"
  ],
  "window": {
    "backgroundTextStyle": "light",
    "navigationBarBackgroundColor": "#1AAD19",
    "navigationBarTitleText": "AI健康助手",
    "navigationBarTextStyle": "white"
  },
  "tabBar": {
    "color": "#7A7E83",
    "selectedColor": "#1AAD19",
    "backgroundColor": "#ffffff",
    "list": [
      {
        "pagePath": "pages/home/home",
        "text": "首页",
        "iconPath": "images/home.png",
        "selectedIconPath": "images/home-active.png"
      },
      {
        "pagePath": "pages/chat/chat",
        "text": "对话",
        "iconPath": "images/chat.png",
        "selectedIconPath": "images/chat-active.png"
      },
      {
        "pagePath": "pages/history/history",
        "text": "历史",
        "iconPath": "images/history.png",
        "selectedIconPath": "images/history-active.png"
      },
      {
        "pagePath": "pages/profile/profile",
        "text": "我的",
        "iconPath": "images/profile.png",
        "selectedIconPath": "images/profile-active.png"
      }
    ]
  }
}
```

#### 修改 `miniprogram/utils/config.ts`

```typescript
// API配置
export const API_CONFIG = {
  // 开发环境
  DEV_BASE_URL: 'http://localhost:8000',
  
  // 生产环境（替换为你的实际域名）
  PROD_BASE_URL: 'https://your-api-domain.com',
  
  // 当前环境
  BASE_URL: process.env.NODE_ENV === 'production' 
    ? 'https://your-api-domain.com'
    : 'http://localhost:8000',
  
  // 超时时间
  TIMEOUT: 30000
};

// 微信小程序配置
export const WECHAT_CONFIG = {
  APP_ID: '你的AppID',
  APP_NAME: 'AI健康助手'
};
```

**替换内容**：
- `PROD_BASE_URL`: 你的后端API域名
- `APP_ID`: 你的小程序AppID

---

## 4. 本地开发

### 4.1 导入项目

1. **打开微信开发者工具**

2. **导入项目**
   - 点击 "+" 或 "导入项目"
   - 选择项目目录：`你的项目路径/miniprogram`
   - AppID：选择你的小程序AppID
   - 项目名称：AI健康助手
   - 点击 "导入"

3. **首次打开配置**
   - 如果提示 "不校验合法域名"，勾选它（开发阶段）
   - 工具栏：详情 → 本地设置
   - 勾选 "不校验合法域名、web-view、TLS版本..."

### 4.2 启动后端服务

在开发小程序前，确保后端服务已启动：

```bash
# 在项目根目录
docker-compose up -d

# 验证服务
curl http://localhost:8000/health
```

### 4.3 开发调试

1. **编译项目**
   - 开发者工具会自动编译
   - 查看控制台是否有错误

2. **模拟器测试**
   - 左侧是模拟器，可以看到小程序界面
   - 点击各个页面测试功能

3. **真机调试**
   - 点击工具栏 "预览"
   - 使用微信扫码
   - 在手机上测试

4. **调试技巧**
   - 控制台：查看日志和错误
   - Network：查看网络请求
   - Storage：查看本地存储
   - AppData：查看页面数据

### 4.4 常用开发命令

```bash
# 清除缓存
工具栏 → 清缓存 → 全部清除

# 重新编译
Ctrl + B (Windows) 或 Cmd + B (macOS)

# 真机调试
工具栏 → 预览 → 扫码
```

---

## 5. 小程序上传发布

### 5.1 准备发布

1. **检查配置**
   - 确认 `project.config.json` 中的AppID正确
   - 确认 `utils/config.ts` 中的生产环境URL正确
   - 确认所有功能测试通过

2. **修改版本号**
   - 在 `project.config.json` 中添加：
   ```json
   {
     "version": "1.0.0",
     "description": "首次发布"
   }
   ```

3. **关闭调试模式**
   - 详情 → 本地设置
   - 取消勾选 "不校验合法域名"

### 5.2 上传代码

1. **点击上传**
   - 工具栏：上传
   - 填写版本号：`1.0.0`
   - 填写项目备注：`首次发布，包含AI对话、体测分析等功能`
   - 点击 "上传"

2. **上传成功**
   - 等待上传完成
   - 会显示 "上传成功" 提示

### 5.3 提交审核

1. **登录小程序后台**
   - 访问：https://mp.weixin.qq.com/
   - 使用管理员微信扫码登录

2. **进入版本管理**
   - 左侧菜单：管理 → 版本管理
   - 找到 "开发版本"
   - 看到刚才上传的版本

3. **提交审核**
   - 点击 "提交审核"
   - 填写审核信息：
     - **功能页面**：选择主要功能页面
     - **测试账号**：提供测试账号（如需要）
     - **类目**：选择 "教育 → 在线教育"
     - **标签**：健康、教育、体育
     - **功能描述**：
       ```
       AI健康助手小程序，提供以下功能：
       1. AI智能对话：健康咨询、运动指导
       2. 体测分析：学生体测数据分析和建议
       3. 资源检索：课课练、运动会等资源
       4. 对话历史：查看历史对话记录
       ```
   - 上传截图：至少3张功能截图
   - 点击 "提交审核"

4. **等待审核**
   - 审核时间：通常1-7个工作日
   - 可在 "版本管理" 查看审核状态
   - 审核结果会通过微信通知

### 5.4 发布上线

1. **审核通过后**
   - 在 "审核版本" 中看到通过的版本
   - 点击 "发布"
   - 确认发布

2. **发布成功**
   - 版本会出现在 "线上版本"
   - 用户可以搜索并使用小程序

### 5.5 版本更新

后续更新流程：

```
1. 修改代码
2. 修改版本号（如 1.0.1）
3. 上传代码
4. 提交审核
5. 审核通过后发布
```

---

## 6. 常见问题

### 问题1：AppID无效

**原因**：AppID配置错误

**解决**：
1. 检查 `project.config.json` 中的appid
2. 确认是否复制完整
3. 重新导入项目

### 问题2：request合法域名校验出错

**原因**：后端域名未配置

**解决**：
1. 登录小程序后台
2. 开发 → 开发管理 → 开发设置
3. 配置服务器域名
4. 或开发阶段勾选 "不校验合法域名"

### 问题3：登录失败

**原因**：后端服务未启动或配置错误

**解决**：
1. 确认后端服务运行：`docker-compose ps`
2. 检查 `utils/config.ts` 中的BASE_URL
3. 查看控制台错误信息

### 问题4：真机预览白屏

**原因**：代码错误或网络问题

**解决**：
1. 查看控制台错误
2. 使用真机调试查看详细日志
3. 检查网络请求是否成功

### 问题5：审核被拒

**常见原因**：
- 功能描述不清晰
- 缺少必要资质
- 内容违规

**解决**：
1. 查看拒绝原因
2. 修改后重新提交
3. 补充必要资质文件

---

## 7. 开发技巧

### 7.1 快捷键

```
Ctrl/Cmd + S: 保存
Ctrl/Cmd + B: 编译
Ctrl/Cmd + Shift + F: 全局搜索
```

### 7.2 调试技巧

```typescript
// 使用console.log调试
console.log('调试信息', data);

// 使用wx.showToast显示提示
wx.showToast({
  title: '操作成功',
  icon: 'success'
});

// 使用wx.showModal显示详细信息
wx.showModal({
  title: '调试',
  content: JSON.stringify(data)
});
```

### 7.3 性能优化

1. **图片优化**
   - 使用WebP格式
   - 压缩图片大小
   - 使用CDN

2. **代码优化**
   - 避免频繁setData
   - 使用分包加载
   - 及时清理定时器

3. **网络优化**
   - 合并请求
   - 使用缓存
   - 请求防抖

---

## 8. 发布检查清单

发布前确认：

- [ ] AppID配置正确
- [ ] 生产环境URL配置正确
- [ ] 所有功能测试通过
- [ ] 真机测试通过
- [ ] 服务器域名已配置
- [ ] 版本号已更新
- [ ] 功能截图已准备
- [ ] 审核信息已填写完整

---

## 9. 相关资源

- **微信公众平台**：https://mp.weixin.qq.com/
- **小程序开发文档**：https://developers.weixin.qq.com/miniprogram/dev/framework/
- **开发者工具下载**：https://developers.weixin.qq.com/miniprogram/dev/devtools/download.html
- **小程序社区**：https://developers.weixin.qq.com/community/minihome

---

**祝你开发顺利！** 🚀
