# 四端分离数据管理功能实施文档

## 📋 概述

本次更新实现了完整的四端分离数据管理系统，包括：
- 教师端：数据上传和管理
- 学生端：个人体测查询
- 家长端：子女体测查询
- 督导端：数据统计分析

## 🎯 核心功能

### 1. 教师端功能
- ✅ 上传班级体测数据（Excel/CSV格式）
- ✅ 上传体育动作库（Excel/CSV格式）
- ✅ 查询学生个人数据
- ✅ 查询班级整体数据
- ✅ AI课课练方案生成
- ✅ 运动会设计

### 2. 学生端功能
- ✅ 通过学号查询个人体测数据
- ✅ 查看各项体测成绩和等级
- ✅ 获取个性化训练推荐
- ✅ AI运动指导咨询

### 3. 家长端功能
- ✅ 通过学号查询孩子体测数据
- ✅ 查看孩子成长报告
- ✅ 获取家庭训练建议
- ✅ AI健康咨询

### 4. 督导端功能
- ✅ 跨班级数据统计
- ✅ 数据对比分析
- ✅ 趋势分析报告
- ✅ AI决策支持

## 📁 文件结构

```
ctz_project/
├── backend/
│   ├── app/
│   │   ├── models/
│   │   │   └── student_data.py          # 数据模型（新增）
│   │   ├── api/
│   │   │   └── data_upload.py           # 数据上传API（新增）
│   │   ├── core/
│   │   │   └── database.py              # 数据库配置（新增）
│   │   └── main.py                      # 主应用（已更新）
│   └── requirements.txt                 # 需要添加依赖
│
├── web-server/
│   ├── templates/
│   │   ├── index.html                   # 主页面（需整合）
│   │   └── data-pages.html              # 数据页面（新增）
│   ├── static/
│   │   ├── js/
│   │   │   ├── app.js                   # 主应用JS（已更新）
│   │   │   └── data-manager.js          # 数据管理JS（新增）
│   │   └── css/
│   │       ├── style.css                # 主样式（需整合）
│   │       └── data-styles.css          # 数据样式（新增）
│   └── start.sh                         # 启动脚本
│
└── data/                                # 示例数据
    ├── 模糊处理体测数据(1).csv
    └── 体育趣味课课练1260例.csv
```

## 🔧 后端更新

### 1. 新增依赖包

在 `backend/requirements.txt` 中添加：

```txt
pandas==2.0.3
openpyxl==3.1.2
sqlalchemy==2.0.20
python-multipart==0.0.6
```

### 2. 数据库模型

创建了两个主要模型：
- `StudentFitnessData`: 学生体测数据表
- `SportsExercise`: 体育动作库表

### 3. API接口

新增以下接口：

| 接口 | 方法 | 说明 | 权限 |
|------|------|------|------|
| `/api/data/upload/fitness-data` | POST | 上传体测数据 | 教师 |
| `/api/data/upload/sports-exercises` | POST | 上传动作库 | 教师 |
| `/api/data/student/{student_id}` | GET | 查询学生数据 | 公开 |
| `/api/data/class/{class_name}` | GET | 查询班级数据 | 教师/督导 |
| `/api/data/exercises/recommend` | GET | 获取训练推荐 | 公开 |

## 🎨 前端更新

### 1. 新增页面

- 教师端数据管理页面
- 学生端查询页面
- 家长端查询页面
- 数据展示模态框

### 2. 新增功能

- 文件上传组件
- 数据查询表单
- 数据可视化展示
- 训练推荐展示
- 加载提示和Toast消息

### 3. 样式更新

- 数据卡片样式
- 表格样式
- 模态框样式
- 响应式布局

## 🚀 部署步骤

### 步骤1：更新后端

```bash
# 1. 进入后端目录
cd backend

# 2. 安装新依赖
pip install pandas openpyxl sqlalchemy python-multipart

# 3. 初始化数据库（首次运行会自动创建）
python -c "from app.core.database import init_db; init_db()"

# 4. 重启后端服务
# 如果使用systemd
sudo systemctl restart ctz-backend

# 或者直接运行
uvicorn app.main:app --host 0.0.0.0 --port 8000
```

### 步骤2：更新前端

```bash
# 1. 进入web-server目录
cd web-server

# 2. 整合HTML文件
# 将 data-pages.html 的内容添加到 index.html 的 </body> 标签之前

# 3. 在 index.html 的 <head> 中添加新的CSS和JS引用
# <link rel="stylesheet" href="/static/css/data-styles.css">
# <script src="/static/js/data-manager.js"></script>

# 4. 重启web服务
./start.sh
```

### 步骤3：导入示例数据

```bash
# 1. 准备数据文件
# 将 data/ 目录下的CSV文件转换为Excel格式（可选）

# 2. 通过教师端界面上传
# - 登录教师端
# - 进入"数据管理"页面
# - 点击"体测数据上传"按钮
# - 选择文件上传

# 3. 或使用API直接上传
curl -X POST "http://your-domain/api/data/upload/fitness-data" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -F "file=@data/模糊处理体测数据(1).csv"
```

## 📊 数据格式说明

### 体测数据格式

必需字段：
- 学生编号（唯一标识）
- 年级、班级、性别
- 各项体测成绩（身高、体重、50米跑等）

示例：
```csv
年级编号,年级,班级名称,学生编号,性别,身高,体重,...
14,四年级,1班,092800001,男,144.4,45.6,...
```

### 动作库数据格式

必需字段：
- 编号（唯一标识）
- 名称、说明
- 难度等级、适用水平
- 提升体测项目

示例：
```csv
名称,来源,编号,说明,使用器械,难度等级,提升体测项目,...
熊样爬行,第二册,284,练习方式：...,平衡木,初级,1分钟跳绳,...
```

## 🧪 测试步骤

### 1. 测试数据上传

```bash
# 教师端登录后
1. 进入"数据管理"页面
2. 点击"体测数据上传"
3. 选择CSV或Excel文件
4. 确认上传成功提示
```

### 2. 测试学生查询

```bash
# 学生端
1. 进入"我的体测"页面
2. 输入学号：092800001
3. 查看体测数据展示
4. 查看训练推荐
```

### 3. 测试家长查询

```bash
# 家长端
1. 进入"孩子体测"页面
2. 输入孩子学号
3. 查看体测数据和建议
```

### 4. 测试班级查询

```bash
# 教师端
1. 进入"数据管理"页面
2. 点击"查询班级数据"
3. 输入班级名称：1班
4. 查看班级统计和学生列表
```

## 🔍 API测试示例

### 上传体测数据

```bash
curl -X POST "http://localhost:8000/api/data/upload/fitness-data" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -F "file=@体测数据.xlsx"
```

### 查询学生数据

```bash
curl "http://localhost:8000/api/data/student/092800001"
```

### 查询班级数据

```bash
curl "http://localhost:8000/api/data/class/1班" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

### 获取训练推荐

```bash
curl "http://localhost:8000/api/data/exercises/recommend?student_id=092800001"
```

## ⚠️ 注意事项

### 1. 数据安全
- 体测数据包含学生隐私信息，需要严格权限控制
- 建议只允许教师端上传数据
- 学生和家长只能查询自己相关的数据

### 2. 文件大小限制
- 默认上传文件大小限制为10MB
- 如需上传更大文件，需修改FastAPI配置

### 3. 数据库备份
- 定期备份SQLite数据库文件（ctz_data.db）
- 建议每天自动备份

### 4. 性能优化
- 大量数据查询时可能较慢
- 建议添加数据库索引
- 考虑使用PostgreSQL替代SQLite

## 🐛 常见问题

### Q1: 上传文件失败
**A:** 检查文件格式是否正确，确保包含所有必需字段

### Q2: 查询不到数据
**A:** 确认学号输入正确，检查数据是否已成功上传

### Q3: 训练推荐为空
**A:** 确认动作库数据已上传，且学生有薄弱项目

### Q4: 数据库初始化失败
**A:** 检查数据库文件权限，确保应用有写入权限

## 📈 后续优化建议

1. **数据可视化**
   - 添加图表展示（折线图、柱状图）
   - 成绩趋势分析

2. **批量操作**
   - 批量导入多个班级数据
   - 批量导出报告

3. **智能分析**
   - AI自动生成体测分析报告
   - 智能推荐训练计划

4. **移动端优化**
   - 响应式设计优化
   - 移动端专属界面

5. **数据导出**
   - 导出Excel报告
   - 生成PDF报告

## 📞 技术支持

如有问题，请联系开发团队或查看项目文档。

---

**版本**: v2.0.0  
**更新日期**: 2025-01-21  
**作者**: AI开发团队
